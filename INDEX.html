<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Informes de Inspección v4.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --color-primario: #0A2D4D; --color-fondo: #f4f7fa; --color-borde: #dce3e9;
            --color-texto: #333; --color-anomalia: #c0392b; --sombra-caja: 0 4px 8px rgba(0,0,0,0.1);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--color-fondo); margin: 0; padding: 20px; color: var(--color-texto); }
        .container { max-width: 1200px; margin: auto; }
        h1 { color: var(--color-primario); text-align: center; }
        .controls { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: var(--sombra-caja); margin-bottom: 30px; }
        .control-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .control-item { display: flex; flex-direction: column; }
        .control-item label { font-weight: 600; margin-bottom: 5px; }
        .control-item input, .control-item select { padding: 10px; border: 1px solid var(--color-borde); border-radius: 4px; width: 100%; box-sizing: border-box; }
        .image-controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
        .image-control-item { background-color: var(--color-fondo); padding: 15px; border-radius: 6px; border: 1px solid var(--color-borde); }
        .image-control-item label { font-weight: bold; display: block; margin-bottom: 10px; }
        .image-control-item select, .image-control-item input[type="text"] { margin-top: 10px; }
        button#generate-btn { background-color: #007bff; color: white; padding: 15px 25px; border: none; border-radius: 5px; font-size: 1.2em; cursor: pointer; display: block; width: 100%; margin-top: 20px; transition: background-color 0.3s; }
        button#generate-btn:hover { background-color: #0069d9; }
        .logo-control { display: flex; align-items: center; gap: 10px; }
        .remove-logo-btn { padding: 5px 10px; font-size: 0.8em; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; }
        
        .report-page { background-color: white; border: 1px solid #ccc; padding: 25px; box-shadow: var(--sombra-caja); aspect-ratio: 16 / 9; display: flex; flex-direction: column; margin-bottom: 20px; }
        
        .report-header { display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid var(--color-primario); padding-bottom: 10px; flex-shrink: 0; }
        .header-col { flex: 1; display: flex; align-items: center; height: 60px; }
        .header-col.left { justify-content: flex-start; }
        .header-col.center { justify-content: center; flex-direction: column; }
        .header-col.right { justify-content: center; }
        .header-separator { width: 2px; background-color: var(--color-primario); height: 100%; }
        .header-col .logo { max-width: 150px; max-height: 50px; object-fit: contain; }
        .header-info { padding-left: 15px; }
        .header-info p { margin: 2px 0; font-size: 0.9em; text-align: left; }
        .header-col.center h2 { margin: 0; line-height: 1.2; font-size: 1.4em; font-weight: 600; color: var(--color-primario); text-align: center; }
        .line-info { text-align: center; flex-grow: 1; }
        .line-info p { margin: 2px 0; font-size: 0.9em; color: var(--color-texto); }
        .line-info .line-name-output { font-size: 1.6em; font-weight: 600; color: var(--color-primario); }

        .report-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); gap: 15px; padding-top: 15px; flex-grow: 1; }
        .grid-item { border: 1px solid var(--color-borde); display: flex; flex-direction: column; position: relative; }
        .grid-item .item-number { position: absolute; top: 5px; left: 5px; background-color: rgba(10, 45, 77, 0.8); color: white; width: 25px; height: 25px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 0.9em; transition: background-color 0.3s; }
        .grid-item img.preview-image { width: 100%; height: 70%; object-fit: cover; background-color: #e9ecef; }
        .grid-item p.description { margin: 0; padding: 10px; font-size: 0.8em; text-align: center; flex-grow: 1; display: flex; justify-content: center; align-items: center; background-color: #f8f9fa; word-break: break-word; transition: color 0.3s; }
        .grid-item.has-anomaly .item-number { background-color: var(--color-anomalia); }
        .grid-item.has-anomaly p.description { color: var(--color-anomalia); font-weight: 500; }
        
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 1.5em; color: var(--color-primario); z-index: 1000; backdrop-filter: blur(4px); }
    </style>
</head>
<body>
    <div id="loader" style="display: none;"><p id="loader-text">Generando imagen...</p></div>
    <datalist id="anomalies-list"></datalist>
    <div class="container">
        <h1>Generador de Informes de Inspección</h1>
        <div class="controls">
            <div class="control-group">
                <div class="control-item"><label for="logo1-input">Logo Izquierdo (Multi X)</label><div class="logo-control"><input type="file" id="logo1-input" accept="image/*"><button class="remove-logo-btn" data-logo-id="1">Eliminar</button></div></div>
                <div class="control-item"><label for="pilot-name-input">Piloto R.O.V</label><input type="text" id="pilot-name-input" value="Ronald Felipe Yañez Pino"></div>
                <div class="control-item"><label for="date-input">Fecha</label><input type="date" id="date-input"></div>
                <div class="control-item"><label for="line-name-input">Línea de Fondeo</label><input type="text" id="line-name-input" placeholder="Ej: L1, Boya 3..."></div>
                <div class="control-item"><label for="logo2-input">Logo Derecho (Vortex)</label><div class="logo-control"><input type="file" id="logo2-input" accept="image/*"><button class="remove-logo-btn" data-logo-id="2">Eliminar</button></div></div>
            </div>
            <hr>
            <h3>1. Cargar Imágenes</h3>
            <div class="control-item"><label for="multi-upload-input">Seleccionar todas las fotos de la inspección</label><input type="file" id="multi-upload-input" accept="image/*" multiple></div>
            <hr>
            <h3>2. Ajustar Descripciones y Añadir Anomalías</h3>
            <div class="image-controls-grid"></div>
            <button id="generate-btn">Exportar Informe como Imagen(es)</button>
        </div>
        <h2>Vista Previa del Informe</h2>
        <div id="report-pages-container"></div>
    </div>
    <script>
        const descriptionsList = ["Seleccione una descripción...", "Conexión boya 7000lts a cadena 32mm mediante grillete de 1 1/2 pulgadas.", "Tramo de cadena 32mm.", "Tramo de cadena 32mm con adherencia de fouling.", "Conexión cadena 32mm a cabo de 56mm mediante grillete de 1 1/2 pulgadas.", "Tramo de cabo 56mm.", "Conexión de cabo 56mm mediante grillete de 1 1/2 pulgadas a cable de 1 1/2 pulgadas.", "Conexión cabo 56mm a cadena de 32mm mediante grillete de 1 1/2 pulgadas.", "Conexión cadena de 32mm a cabo de 56mm mediante grillete de 1 1/2 pulgadas.", "Conexión cadena 32mm a peso muerto mediante grillete de 1 1/2 pulgadas."];
        const anomaliesList = ["Cruce de línea con roce", "Cruce de línea sin roce", "Roce en línea (sin cruce)", "Corte en cabo", "Desgarro en cabo", "Enredo en línea", "Degradación por UV", "Desgaste por abrasión", "Corrosión superficial", "Corrosión avanzada", "Pérdida de galvanizado", "Fisura en componente", "Rotura de componente", "Deformación de componente", "Perno de grillete suelto", "Discrepancia con plano de fondeo", "Componente suelto", "Componente faltante", "Garreo de ancla (ancla movida de su posición)", "Bioincrustación (Fouling)"];
        const defaultDescriptionSequence = ["Conexión boya 7000lts a cadena 32mm mediante grillete de 1 1/2 pulgadas.", "Tramo de cadena 32mm", "Tramo de cadena 32mm", "Conexión cadena 32mm a cabo de 56mm mediante grillete de 1 1/2 pulgadas.", "Tramo de cabo 56mm", "Tramo de cabo 56mm", "Tramo de cabo 56mm", "Conexión cabo 56mm a cadena de 32mm mediante grillete de 1 1/2 pulgadas.", "Tramo de cadena 32mm", "Tramo de cadena 32mm", "Tramo de cadena 32mm", "Conexión cadena 32mm a peso muerto mediante grillete de 1 1/2 pulgadas."];
        let reportData = [];
        let logo1Src = null, logo2Src = null;
        document.addEventListener('DOMContentLoaded', () => {
            const elements = { pilotNameInput: document.getElementById('pilot-name-input'), dateInput: document.getElementById('date-input'), lineNameInput: document.getElementById('line-name-input'), logo1Input: document.getElementById('logo1-input'), logo2Input: document.getElementById('logo2-input'), imageControlsGrid: document.querySelector('.image-controls-grid'), reportPagesContainer: document.getElementById('report-pages-container'), generateBtn: document.getElementById('generate-btn'), loader: document.getElementById('loader'), loaderText: document.getElementById('loader-text'), anomaliesDatalist: document.getElementById('anomalies-list'), multiUploadInput: document.getElementById('multi-upload-input') };
            elements.dateInput.value = new Date().toISOString().split('T')[0];
            anomaliesList.forEach(item => elements.anomaliesDatalist.appendChild(new Option('', item)));
            const handleImageUpload = (file, previewElement) => { if (file && previewElement) { const reader = new FileReader(); reader.onload = e => previewElement.src = e.target.result; reader.readAsDataURL(file); } };
            const updateDescription = (index) => { const data = reportData[index]; if (!data) return; const outputElement = document.getElementById(`description-output-${index}`), gridItem = document.getElementById(`grid-item-${index}`); if (!outputElement || !gridItem) return; let finalDescription = "Sin descripción"; if (data.description && data.anomaly) finalDescription = `${data.description}, ${data.anomaly}`; else if (data.description) finalDescription = data.description; else if (data.anomaly) finalDescription = data.anomaly; outputElement.textContent = finalDescription; gridItem.classList.toggle('has-anomaly', !!data.anomaly); };
            const fileToBase64 = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); });
            const updateHeaders = () => { const pilotName = elements.pilotNameInput.value, date = elements.dateInput.value, lineName = elements.lineNameInput.value; document.querySelectorAll('.pilot-name-output').forEach(el => el.textContent = pilotName); document.querySelectorAll('.date-output').forEach(el => el.textContent = date); document.querySelectorAll('.line-name-output').forEach(el => el.textContent = lineName); const finalLogo1Src = logo1Src || "https://via.placeholder.com/150x50.png?text=Logo+1"; const finalLogo2Src = logo2Src || "https://via.placeholder.com/150x50.png?text=Logo+2"; document.querySelectorAll('.logo1-preview').forEach(el => el.src = finalLogo1Src); document.querySelectorAll('.logo2-preview').forEach(el => el.src = finalLogo2Src); };
            const renderUI = () => { elements.imageControlsGrid.innerHTML = ''; elements.reportPagesContainer.innerHTML = ''; reportData.forEach((data, index) => { const controlItem = document.createElement('div'); controlItem.className = 'image-control-item'; controlItem.innerHTML = `<label>Elemento #${index + 1}</label><select data-type="desc" data-index="${index}"></select><input type="text" placeholder="Añadir anomalía (opcional)..." list="anomalies-list" data-type="anomaly" data-index="${index}">`; const select = controlItem.querySelector('select'); descriptionsList.forEach(desc => select.appendChild(new Option(desc, desc === "Seleccione una descripción..." ? "" : desc))); select.value = data.description; controlItem.querySelector('input').value = data.anomaly; elements.imageControlsGrid.appendChild(controlItem); }); const CHUNK_SIZE = 9; for (let i = 0; i < reportData.length; i += CHUNK_SIZE) { const pageChunk = reportData.slice(i, i + CHUNK_SIZE); const pageElement = document.createElement('div'); pageElement.className = 'report-page'; const headerHTML = `<header class="report-header"><div class="header-col left"><img class="logo logo1-preview"><div class="header-info"><p><strong>Piloto R.O.V:</strong> <span class="pilot-name-output"></span></p><p><strong>Fecha:</strong> <span class="date-output"></span></p></div></div><div class="header-separator"></div><div class="header-col center"><h2>INFORME DE INSPECCIÓN<br>SUBMARINA</h2></div><div class="header-separator"></div><div class="header-col right"><div class="line-info"><p>Línea de Fondeo:</p><p class="line-name-output"></p></div><img class="logo logo2-preview"></div></header>`; const gridItemsHTML = pageChunk.map((data, index) => { const globalIndex = i + index; return `<div class="grid-item" id="grid-item-${globalIndex}"><div class="item-number">${globalIndex + 1}</div><img id="preview-image-${globalIndex}" class="preview-image"><p id="description-output-${globalIndex}" class="description"></p></div>`; }).join(''); pageElement.innerHTML = `${headerHTML}<main class="report-grid">${gridItemsHTML}</main>`; elements.reportPagesContainer.appendChild(pageElement); pageChunk.forEach((data, index) => { const globalIndex = i + index; if (data.file) handleImageUpload(data.file, document.getElementById(`preview-image-${globalIndex}`)); updateDescription(globalIndex); }); } updateHeaders(); };
            const loadLogosFromStorage = () => { logo1Src = localStorage.getItem('savedLogo1'); logo2Src = localStorage.getItem('savedLogo2'); renderUI(); };
            elements.logo1Input.addEventListener('change', async (e) => { if (e.target.files[0]) { logo1Src = await fileToBase64(e.target.files[0]); localStorage.setItem('savedLogo1', logo1Src); renderUI(); } });
            elements.logo2Input.addEventListener('change', async (e) => { if (e.target.files[0]) { logo2Src = await fileToBase64(e.target.files[0]); localStorage.setItem('savedLogo2', logo2Src); renderUI(); } });
            document.querySelectorAll('.remove-logo-btn').forEach(btn => { btn.addEventListener('click', () => { const logoId = btn.dataset.logoId; if (logoId === '1') { logo1Src = null; localStorage.removeItem('savedLogo1'); elements.logo1Input.value = ''; } else if (logoId === '2') { logo2Src = null; localStorage.removeItem('savedLogo2'); elements.logo2Input.value = ''; } renderUI(); }); });
            elements.pilotNameInput.addEventListener('input', updateHeaders);
            elements.dateInput.addEventListener('input', updateHeaders);
            elements.lineNameInput.addEventListener('input', updateHeaders);
            elements.imageControlsGrid.addEventListener('input', e => { const { type, index } = e.target.dataset; if (!reportData[index]) return; if (type === 'desc') reportData[index].description = e.target.value; if (type === 'anomaly') reportData[index].anomaly = e.target.value; updateDescription(index); });
            elements.multiUploadInput.addEventListener('change', (e) => { const files = Array.from(e.target.files).filter(file => file.type.startsWith('image/')); files.sort((a, b) => a.name.localeCompare(b.name)); reportData = files.map((file, index) => ({ file, description: defaultDescriptionSequence[index] || '', anomaly: '' })); renderUI(); });
            elements.generateBtn.addEventListener('click', async () => { const pages = document.querySelectorAll('.report-page'); if (pages.length === 0) { alert("Por favor, cargue imágenes primero."); return; } elements.loader.style.display = 'flex'; for (let i = 0; i < pages.length; i++) { elements.loaderText.textContent = `Generando página ${i + 1} de ${pages.length}...`; try { const canvas = await html2canvas(pages[i], { scale: 3, useCORS: true }); const link = document.createElement('a'); link.download = `informe-${elements.dateInput.value}-${elements.lineNameInput.value || 'sin-linea'}-p${i + 1}.png`; link.href = canvas.toDataURL('image/png'); link.click(); await new Promise(resolve => setTimeout(resolve, 500)); } catch (err) { console.error(`Error generando página ${i+1}:`, err); alert(`Hubo un error al generar la página ${i + 1}.`); break; } } elements.loader.style.display = 'none'; });
            loadLogosFromStorage();
        });
    </script>
</body>
</html>
